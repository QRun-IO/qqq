---

version: 2.1

# Pipeline parameters for optional workflows
parameters:
  run_static_analysis:
    type: boolean
    default: false
    description: "Run SpotBugs and PMD static analysis"

orbs:
  # TODO: Change back to @0.6.0 after testing
  qqq-orb: kingsrook/qqq-orb@dev:snapshot

workflows:

  test_only:
    jobs:
      - qqq-orb/mvn_test_only:
          context: [qqq-maven-registry-credentials, build-qqq-sample-app]
          filters:
            branches:
              ignore: /(develop|main|release/.*|hotfix/.*|integration.*)/
            tags:
              only: []

  publish_snapshot:
    jobs:
      - qqq-orb/mvn_publish:
          context: [qqq-maven-registry-credentials, build-qqq-sample-app]
          branch_type: snapshot
          filters:
            branches:
              only:
                - develop

  publish_feature:
    jobs:
      - qqq-orb/mvn_publish:
          context: [qqq-maven-registry-credentials]
          branch_type: feature
          filters:
            branches:
              only:
                - feature/.*
            tags:
              only: [/publish.*/]

  publish_release_candidate:
    jobs:
      - qqq-orb/mvn_publish:
          context: [qqq-maven-registry-credentials, build-qqq-sample-app]
          branch_type: release_candidate
          filters:
            branches:
              only:
                - /release\/.*/

  publish_release:
    jobs:
      - qqq-orb/mvn_publish:
          context: [qqq-maven-registry-credentials, build-qqq-sample-app]
          branch_type: release
          filters:
            branches:
              only: [main]
            tags:
              only: [/v.*/]

  publish_hotfix_release:
    jobs:
      - qqq-orb/mvn_publish:
          context: [qqq-maven-registry-credentials, build-qqq-sample-app]
          branch_type: hotfix
          filters:
            branches:
              only:
                - /hotfix\/.*/

  # Static analysis workflow
  # Triggered by: git tag static-analysis/$(date +%Y%m%d) && git push origin --tags
  # Or via API: POST with run_static_analysis=true
  static_analysis:
    when:
      or:
        - matches:
            pattern: "^static-analysis/.*"
            value: << pipeline.git.tag >>
        - equal: [true, << pipeline.parameters.run_static_analysis >>]
    jobs:
      - qqq-orb/static_analysis:
          context: [qqq-maven-registry-credentials]
